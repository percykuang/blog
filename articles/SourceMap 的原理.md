@date: 2023-05-15
@tag: [webpack]

## 前言

SourceMap 是一种将压缩、合并或转译后的代码映射回原始源代码的技术，主要用于调试和错误追踪。它的核心原理是通过记录压缩代码与原始代码之间的位置对应关系，使开发者工具（如浏览器 DevTools）能够将压缩后的代码位置“翻译”回原始代码的位置。

## SourceMap 的核心组成

一个 SourceMap 文件（通常是 `.map`` 后缀）包含以下关键信息（类似于一个 JSON 的格式，具有以下 6 个字段）：

1. **版本（version）**：当前 SourceMap 的版本（如 3）。

2. **文件（file）**：生成的压缩文件名（如 bundle.min.js）。

3. **原始文件列表（sources）**：所有原始源文件的路径（如 ["src/index.js", "src/utils.js"]）。

4. **原始内容（sourcesContent）**：可选，直接包含原始代码内容，避免额外请求。

5. **名称（names）**：压缩过程中被缩短的变量名或函数名的原始名称（如将 myVariable 压缩为 a）。

6. **映射数据（mappings）**：最核心的部分，通过特定编码（如 VLQ）记录压缩代码与原始代码的位置对应关系。

## 映射数据（mappings）的编码原理

`mappings` 字段是一个字符串，通过分段编码记录了每个生成代码位置对应的原始位置。其编码过程如下：

1. 位置分段

- 每一行生成代码（压缩后的代码）用分号 ; 分隔。

- 同一行内的每个位置映射用逗号 , 分隔。

- 每个位置映射包含 1-5 个字段，用 VLQ 编码表示：

```
生成的列 > 原始文件索引 > 原始行 > 原始列 > （可选）名称索引
```

2. VLQ（Variable Length Quantity）编码

- VLQ 是一种变长编码，能将大整数转换为 Base64 字符，减少文件体积。

- 每个位置字段的值是相对于前一个位置的 偏移量（而非绝对值），进一步压缩数据。

- 例如：数值 7 的 VLQ 编码是 7 → Base64 字符 7；数值 1000 的 VLQ 编码是 qB。

3. 编码示例

假设有以下映射字符串：

```
mappings: "AAAA,SAASA,CAASC"
```

解码后可能表示：

- AAAA → 生成代码第 0 列 → 对应原始文件 0 的第 0 行第 0 列。

- SAASA → 生成代码第 1 列 → 对应原始文件 1 的第 1 行第 0 列。

## 生成与使用流程

1. 生成阶段：

- 构建工具（如 Webpack、Babel、Terser）在压缩/转译代码时生成 SourceMap。

- 工具会记录每个生成代码位置对应的原始文件、行号、列号及原始名称。

2. 浏览器使用阶段：

- 浏览器检测到压缩文件末尾的 //# sourceMappingURL=bundle.min.js.map 注释时，会加载 SourceMap。

- 开发者工具（如 Chrome DevTools）根据 SourceMap 将压缩代码的位置映射回原始代码，显示原始文件名、行号等信息。

## 注意事项

1. 安全性：生产环境应避免暴露 SourceMap 文件，否则可能泄露源代码。

2. 性能：SourceMap 仅在打开开发者工具时加载，不影响普通用户性能。

3. 兼容性：现代浏览器均支持 SourceMap。

## 总结

通过这种映射机制，SourceMap 让开发者能在压缩代码中直接调试原始代码，极大提升了开发体验。
